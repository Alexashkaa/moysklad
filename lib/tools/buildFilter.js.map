{"version":3,"sources":["../../src/tools/buildFilter.js"],"names":["getTimeString","require","isObject","isSimpleValue","createValueSelector","selector","path","value","Error","createCollectionSelector","sel","Array","reduce","res","v","concat","selectors","eq","operator","gt","gte","lt","lte","ne","in","collection","nin","not","comparisonSelectors","Object","keys","key","op","invertFilterPart","fp","getFilterParts","pathLen","length","curKey","val","slice","headPath","map","parts","error","message","module","exports","buildFilter","filter","filterParts","part","join","undefined","Date","sort","p1","p2"],"mappings":"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","file":"buildFilter.js","sourcesContent":["'use strict'\n\nconst getTimeString = require('./getTimeString')\nconst isObject = require('./isObject')\nconst isSimpleValue = require('./isSimpleValue')\n\nlet createValueSelector = selector => (path, value) => {\n  if (!isSimpleValue(value)) {\n    throw new Error(`value must to be string, number, date or null`)\n  }\n  return [[path, selector, value]]\n}\n\nlet createCollectionSelector = selector => {\n  const sel = createValueSelector(selector)\n  return (path, value) => {\n    if (!(value instanceof Array)) {\n      throw new Error(`selector value must to be an array`)\n    }\n    return value.reduce((res, v) => res.concat(sel(path, v)), [])\n  }\n}\n\n// Comparison selectors\nconst selectors = {\n  eq: { operator: '=' },\n  gt: { operator: '>' },\n  gte: { operator: '>=' },\n  lt: { operator: '<' },\n  lte: { operator: '>=' },\n  ne: { operator: '!=' },\n  in: { operator: '=', collection: true },\n  nin: { operator: '!=', collection: true }\n}\n\nselectors.eq.not = selectors.ne\nselectors.gt.not = selectors.lte\nselectors.gte.not = selectors.lt\nselectors.lt.not = selectors.gte\nselectors.lte.not = selectors.gt\nselectors.ne.not = selectors.eq\nselectors.in.not = selectors.nin\nselectors.nin.not = selectors.in\n\nconst comparisonSelectors = Object.keys(selectors).reduce((res, key) => {\n  let op = selectors[key]\n  res['$' + key] = (op.collection ? createCollectionSelector : createValueSelector)(op)\n  return res\n}, {})\n\n// Logical selectors\nconst invertFilterPart = fp => [fp[0], fp[1].not, fp[2]]\n\nfunction getFilterParts (path, value) {\n  const pathLen = path.length\n  const curKey = pathLen ? path[pathLen - 1] : null\n\n  switch (true) {\n    // Mongo logical selectors\n    case curKey === '$and':\n      if (!(value instanceof Array)) {\n        throw new Error(`$and: selector value must to be an array`)\n      }\n      return value.reduce((res, val) => res\n        .concat(getFilterParts(path.slice(0, -1), val)), [])\n\n    case curKey === '$not':\n      if (!isObject(value)) {\n        throw new Error(`$not: selector value must to be an object`)\n      }\n      let headPath = path.slice(0, -1)\n      return getFilterParts(headPath, value)\n        .map(invertFilterPart)\n        .concat([[headPath, selectors.eq, null]])\n\n    case curKey === '$exists':\n      if (typeof value !== 'boolean') {\n        throw new Error(`$exists: elector value must to be boolean`)\n      }\n      return [[path.slice(0, -1), selectors.ne, null]]\n\n    // Mongo comparison selectors\n    case !!comparisonSelectors[curKey]:\n      let parts\n      try {\n        parts = comparisonSelectors[curKey](path.slice(0, -1), value)\n      } catch (error) {\n        throw new Error(`${curKey}: ${error.message}`)\n      }\n      return parts\n\n    // Array\n    case value instanceof Array:\n      return value.reduce((res, val) => res\n        .concat(getFilterParts(path, val)), [])\n\n    // Object\n    case !isSimpleValue(value):\n      return Object.keys(value).reduce((res, key) => res\n        .concat(getFilterParts(path.concat(key), value[key])), [])\n\n    // some other value\n    default:\n      return [[path, selectors.eq, value]]\n  }\n}\n\nmodule.exports = function buildFilter (filter) {\n  if (!isObject(filter)) {\n    throw new Error('filter must to be an object')\n  }\n\n  let filterParts = getFilterParts([], filter)\n\n  // преобразование ключа в строку\n  filterParts = filterParts.map(part => [part[0].join('.'), part[1], part[2]])\n\n  return filterParts\n    // конвертация операторов и значений в строку\n    .map(part => {\n      let key = part[0]\n      let operator = part[1].operator\n      let value = part[2]\n      switch (true) {\n        case value === undefined:\n          throw new Error(`filter \"${key}\" key value is undefined`)\n\n        case value === null:\n          return [key, operator, '']\n\n        case value instanceof Date:\n          return [key, operator, getTimeString(value)]\n\n        case typeof value === 'string':\n        case typeof value === 'number':\n          return [key, operator, value]\n\n        default:\n          throw new Error(`filter \"${key}\" key value is incorrect`)\n      }\n    })\n    .map(part => `${part[0]}${part[1]}${part[2]}`)\n    .sort((p1, p2) => {\n      if (p1 > p2) { return 1 }\n      if (p1 < p2) { return -1 }\n      return 0\n    })\n    .join(';')\n}\n\n"]}